# Local development environment
# Usage: docker-compose up -d
version: '3.8'

services:
  # Application (optional - for running containerized locally)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - SERVER_PORT=8080
      - MANAGEMENT_PORT=8081
      - LOG_LEVEL=DEBUG
      {%- if values.database == "aurora-postgresql" %}
      - DATABASE_URL=jdbc:postgresql://postgres:5432/${{values.name}}
      - DATABASE_USERNAME=postgres
      - DATABASE_PASSWORD=postgres
      {%- endif %}
      {%- if values.database == "aurora-mysql" %}
      - DATABASE_URL=jdbc:mysql://mysql:3306/${{values.name}}
      - DATABASE_USERNAME=root
      - DATABASE_PASSWORD=mysql
      {%- endif %}
      {%- if values.cache == "elasticache-redis" %}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      {%- endif %}
    depends_on:
      {%- if values.database == "aurora-postgresql" %}
      postgres:
        condition: service_healthy
      {%- endif %}
      {%- if values.database == "aurora-mysql" %}
      mysql:
        condition: service_healthy
      {%- endif %}
      {%- if values.cache == "elasticache-redis" %}
      redis:
        condition: service_healthy
      {%- endif %}
    networks:
      - app-network
    profiles:
      - app

  {%- if values.database == "aurora-postgresql" %}
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: ${{values.name}}
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
  {%- endif %}

  {%- if values.database == "aurora-mysql" %}
  # MySQL Database
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: mysql
      MYSQL_DATABASE: ${{values.name}}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
  {%- endif %}

  {%- if values.cache == "elasticache-redis" %}
  # Redis Cache
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network
  {%- endif %}

  # LocalStack for AWS services (SQS, SNS, DynamoDB, etc.)
  {%- if values.database == "dynamodb" or values.messaging == "sqs" or values.messaging == "sns-sqs" %}
  localstack:
    image: localstack/localstack:3
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
    environment:
      - SERVICES={%- if values.database == "dynamodb" %}dynamodb{%- endif %}{%- if values.messaging == "sqs" or values.messaging == "sns-sqs" %}{%- if values.database == "dynamodb" %},{%- endif %}sqs{%- endif %}{%- if values.messaging == "sns-sqs" %},sns{%- endif %}
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts/localstack-init.sh:/etc/localstack/init/ready.d/init.sh:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - app-network
  {%- endif %}

  # Datadog Agent (local observability)
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    ports:
      - "8126:8126"  # APM
      - "8125:8125/udp"  # DogStatsD
    environment:
      - DD_API_KEY=${DD_API_KEY:-}
      - DD_SITE=${DD_SITE:-datadoghq.com}
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      - DD_CONTAINER_EXCLUDE="name:datadog-agent"
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    networks:
      - app-network
    profiles:
      - observability

networks:
  app-network:
    driver: bridge

volumes:
  {%- if values.database == "aurora-postgresql" %}
  postgres-data:
  {%- endif %}
  {%- if values.database == "aurora-mysql" %}
  mysql-data:
  {%- endif %}
  {%- if values.cache == "elasticache-redis" %}
  redis-data:
  {%- endif %}
  {%- if values.database == "dynamodb" or values.messaging == "sqs" or values.messaging == "sns-sqs" %}
  localstack-data:
  {%- endif %}
